<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Modern Business - uim Framework</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="https://uimsolutions.github.io/uim/assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="https://uimsolutions.github.io/uim/css/styles.css" rel="stylesheet" />
    </head>
    <body class="d-flex flex-column">
        <main class="flex-shrink-0">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container px-5">
        <a class="navbar-brand" href="index.html">uim</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="faq.html">FAQ</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdownBlog" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Packages</a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownBlog">
                        <li><a class="dropdown-item" href="blog-home.html">Blog Home</a></li>
                        <li><a class="dropdown-item" href="blog-post.html">Blog Post</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdownBlog" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Blog</a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownBlog">
                        <li><a class="dropdown-item" href="blog-home.html">Blog Home</a></li>
                        <li><a class="dropdown-item" href="blog-post.html">Blog Post</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdownPortfolio" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Portfolio</a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownPortfolio">
                        <li><a class="dropdown-item" href="portfolio-overview.html">Portfolio Overview</a></li>
                        <li><a class="dropdown-item" href="portfolio-item.html">Portfolio Item</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>	

            <!-- Header-->
            <header class="py-5">
                <div class="container px-5">
                    <div class="row justify-content-center">
                        <div class="col-lg-8 col-xxl-6">
                            <div class="text-left my-5">
                                <nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/index.html">API</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/index.html">uim</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/http/index.html">http</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/http/classes/index.html">classes</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/http/classes/middleware/index.html">middleware</a></li><li class="breadcrumb-item active" aria-current="page">csrfprotection</li></ol></nav>
                                <h1 class="fw-bolder mb-3">Class DCsrfProtectionMiddleware</h1>
                                <table><tr><td>super:DMiddleware</td></tr><tr><td>filepath:C:\Users\ONS\PROJECTS2023\uim\http\uim\http\classes\middleware\csrfprotection.d</td></tr><tr><td>parents:["DMiddleware"]</td></tr><tr><td>namespace:uim.http.classes.middleware.csrfprotection</td></tr><tr><td>name:DCsrfProtectionMiddleware</td></tr><tr><td>content:["    mixin(MiddlewareThis!(\"CsrfProtection\"));","    /**","     * Config for the CSRF handling.","     *","     * - `cookieName` The name of the cookie to send.","     * - `expiry` A strotime compatible value of how long the CSRF token should last.","     *  Defaults to browser session.","     * - `secure` Whether the cookie will be set with the Secure flag. Defaults to false.","     * - `httponly` Whether the cookie will be set with the HttpOnly flag. Defaults to false.","     * - `samesite` \"SameSite\" attribute for cookies. Defaults to `null`.","     *  Valid values: `ICookie.SAMESITE_LAX`, `ICookie.SAMESITERRORS.NOTICE`,","     *  `ICookie.SAMESITE_NONE` or `null`.","     * - `field` The form field to check. Changing this will also require configuring","     *  FormHelper.","     *","     */","    protected Json[sting] _config = createMap!(string, Json)","        .set(\"cookieName\", \"csrfToken\")","        .set(\"expiry\", 0)","        .set(\"secure\", false)","        .set(\"httponly\", false)","        .set(\"samesite\", Json(null))","        .set(\"field\", \"_csrfToken\");","    /**","     * Callback for deciding whether to skip the token check for particular request.","     *","     * CSRF protection token check will be skipped if the callback returns `true`.","     */","    protected callable skipCheckCallback;","    const int TOKEN_VALUE_LENGTH = 16;","    /**","     * Tokens have an hmac generated so we can ensure","     * that tokens were generated by our application.","     *","     * Should be TOKEN_VALUE_LENGTH + hmac.length","     *","     * We are currently using sha1 for the hmac which","     * creates 40 bytes.","     */","    const int TOKEN_WITH_CHECKSUM_LENGTH = 56;","    this(Json[string] configData = null) {","       _config = configData + _config;","    }","    // Checks and sets the CSRF token depending on the HTTP verb.","    IResponse process(IServerRequest serverRequest, IRequestHandler requestHandler) {","        auto method = requestHandler.getMethod();","        auto hasData = isIn(method, [\"PUT\", \"POST\", \"DELETE\", \"PATCH\"], true)","            || requestHandler.getParsedBody();","        if (","            hasData","            && _skipCheckCallback !is null","            && call_user_func(_skipCheckCallback, requestHandler) == true","       ) {","            requestHandler = _unsetTokenField(requestHandler);","            return requestHandler.handle(requestHandler);","        }","        if (requestHandler.getAttribute(\"csrfToken\")) {","            throw new DException(","                \"A CSRF token is already set in the request.\\n\" ~","                \"Ensure you do not have the CSRF middleware applied more than once. \" ~","                \"Check both your `Application.middleware()` method and `config/routes.d`.\"","           );","        }","        auto cookies = requestHandler.getCookieParams();","        auto cookieData = Hash.get(cookies, configuration.get(\"cookieName\"));","        if (isString(cookieData) && !cookieData.isEmpty) {","            try {","                requestHandler = requestHandler.withAttribute(\"csrfToken\", this.saltToken(cookieData));","            } catch (InvalidArgumentException  anException) {","                cookieData = null;","            }","        }","        if (method == \"GET\" && cookieData.isNull) {","            token = this.createToken();","            requestHandler = requestHandler.withAttribute(\"csrfToken\", this.saltToken(token));","            response = requestHandler.handle(requestHandler);","            return _addTokenCookie(token, requestHandler, response);","        }","        if (hasData) {","           _validateToken(requestHandler);","            requestHandler = _unsetTokenField(requestHandler);","        }","        return requestHandler.handle(requestHandler);","    }","    /**","     * Set callback for allowing to skip token check for particular request.","     *","     * The callback will receive request instance as argument and must return","     * `true` if you want to skip token check for the current request.","     */","    void skipCheckCallback(callable aCallback) {","        _skipCheckCallback = aCallback;","    }","    /**","     * Remove CSRF protection token from request data.","     * Params:","     * \\Psr\\Http\\Message\\IServerRequest serverRequest The request object.","     */","    protected IServerRequest _unsetTokenField(IServerRequest serverRequest) {","        auto parsedBody = serverRequest.getParsedBody();","        if (parsedBody.isArray) {","            parsedBody.removeKey(configuration.getString(\"field\"));","            serverRequest = serverRequest.withParsedBody(parsedBody);","        }","        return serverRequest;","    }","    // Create a new token to be used for CSRF protection","    string createToken() {","        auto value = Security.randomBytes(TOKEN_VALUE_LENGTH);","        return base64_encode(value ~ hash_hmac(\"sha1\", value, Security.getSalt()));","    }","    /**","     * Apply entropy to a CSRF token","     *","     * To avoid BREACH apply a random salt value to a token","     * When the token is compared to the session the token needs","     * to be unsalted.","     * Params:","     * string atoken The token to salt.","     */","    string saltToken(string atoken) {","        if (isHexadecimalToken(token)) {","            return token;","        }","        decoded = base64_decode(token, true);","        if (decoded == false) {","            throw new DInvalidArgumentException(\"Invalid token data.\");","        }","        length = decoded.length;","        salt = Security.randomBytes(length);","        string salted = \"\";","        for (index = 0;  index < length;  index++) {","            // XOR the token and salt together so that we can reverse it later.","            salted ~= chr(ord(decoded[index]) ^ ord(salt[index]));","        }","        return base64_encode(salted ~ salt);","    }","    /**","     * Remove the salt from a CSRF token.","     *","     * If the token is not TOKEN_VALUE_LENGTH * 2 it is an old","     * unsalted value that is supported for backwards compatibility.","     * Params:","     * string atoken The token that could be salty.","     */","    string unsaltToken(string atoken) {","        if (isHexadecimalToken(token)) {","            return token;","        }","        auto decoded = base64_decode(token, true);","        if (decoded == false || decoded.length != TOKEN_WITH_CHECKSUM_LENGTH * 2) {","            return token;","        }","        auto salted = subString(decoded, 0, TOKEN_WITH_CHECKSUM_LENGTH);","        auto salt = subString(decoded, TOKEN_WITH_CHECKSUM_LENGTH);","        string unsalted = \"\";","        for (index = 0;  index < TOKEN_WITH_CHECKSUM_LENGTH;  index++) {","            // Reverse the XOR to desalt.","            unsalted ~= chr(ord(salted[index]) ^ ord(salt[index]));","        }","        return base64_encode(unsalted);","    }","    // Verify that CSRF token was originally generated by the receiving application.","    protected bool _verifyToken(string csrfToken) {","        // If we have a hexadecimal value we're in a compatibility mode from before","        // tokens were salted on each request.","        string decoded = isHexadecimalToken(csrfToken)","            ? csrfToken","            : base64_decode(csrfToken, true);","        if (!decoded || decoded.length <= TOKEN_VALUE_LENGTH) {","            return false;","        }","        auto aKey = subString(decoded, 0, TOKEN_VALUE_LENGTH);","        auto hmac = subString(decoded, TOKEN_VALUE_LENGTH);","        auto expectedHmac = hash_hmac(\"sha1\", aKey, Security.getSalt());","        return hash_equals(hmac, expectedHmac);","    }","    // Add a CSRF token to the response cookies.","    protected IResponse _addTokenCookie(","        string tokenToAdd,","        IServerRequest serverRequest,","        IResponse response","   ) {","        auto cookie = _createCookie(tokenToAdd, serverRequest);","        return cast(Response)response","            ? response.withCookie(cookie)","            : response.withAddedHeader(\"Set-Cookie\", cookie.toHeaderValue());","    }","    /**","     * Validate the request data against the cookie token.","     * Params:","     * \\Psr\\Http\\Message\\IServerRequest serverRequest The request to validate against.","     */","    protected void _validateToken(IServerRequest serverRequest) {","        auto cookie = Hash.get(request.getCookieParams(), configuration.get(\"cookieName\"));","        if (!cookie || !isString(cookie)) {","            throw new DInvalidCsrfTokenException(__d(\"uim\", \"Missing or incorrect CSRF cookie type.\"));","        }","        if (!_verifyToken(cookie)) {","            exception = new DInvalidCsrfTokenException(__d(\"uim\", \"Missing or invalid CSRF cookie.\"));","            expiredCookie = _createCookie(\"\", request).withExpired();","            exception.setHeader(\"Set-Cookie\", expiredCookie.toHeaderValue());","            throw exception;","        }","        auto parsedBody = request.getParsedBody();","        if (parsedBody.isArray || cast(DArrayAccess)parsedBody) {","            auto post = to!string(Hash.get(parsedBody, configuration.get(\"field\")));","            post = this.unsaltToken(post);","            if (hash_equals(post, cookie)) {","                return;","            }","        }","         auto aHeader = request.getHeaderLine(\"X-CSRF-Token\");","         aHeader = this.unsaltToken(aHeader);","        if (hash_equals(aHeader, cookie)) {","            return;","        }","        throw new DInvalidCsrfTokenException(__d(","            \"uim\",","            \"CSRF token from either the request body or request headers did not match or is missing.\"","       ));","    }","    // Create response cookie","    protected ICookie _createCookie(string cookieValue, IServerRequest serverRequest) {","        return Cookie.create(","           configuration.get(\"cookieName\"),","            cookieValue,","            [","                \"expires\": configuration.get(\"expiry\"),","                \"path\": request.getAttribute(\"webroot\"),","                \"secure\": configuration.get(\"secure\"),","                \"httponly\": configuration.get(\"httponly\"),","                \"samesite\": configuration.get(\"samesite\"),","            ]","       );","    }"]</td></tr><tr><td>methods:[{"isProperty":false,"datatype":null,"name":"this","isAbstract":false,"isInherited":false,"header":"this(Json[string] configData = null)","isStatic":false},{"isProperty":false,"parameters":["IServerRequest serverRequest","IRequestHandler requestHandler"],"datatype":"IResponse","name":"process","isAbstract":false,"isInherited":false,"header":"IResponse process(IServerRequest serverRequest, IRequestHandler requestHandler)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (requestHandler.getAttribute(\"csrfToken\"))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (isString(cookieData) && !cookieData.isEmpty)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (method == \"GET\" && cookieData.isNull)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (hasData)","isStatic":false},{"isProperty":false,"parameters":["callable aCallback"],"datatype":"void","name":"skipCheckCallback","isAbstract":false,"isInherited":false,"header":"void skipCheckCallback(callable aCallback)","isStatic":false},{"isProperty":false,"parameters":["IServerRequest serverRequest"],"datatype":"protected","name":"IServerRequest _unsetTokenField","isAbstract":false,"isInherited":false,"header":"protected IServerRequest _unsetTokenField(IServerRequest serverRequest)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (parsedBody.isArray)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"string","name":"createToken","isAbstract":false,"isInherited":false,"header":"string createToken()","isStatic":false},{"isProperty":false,"parameters":["string atoken"],"datatype":"string","name":"saltToken","isAbstract":false,"isInherited":false,"header":"string saltToken(string atoken)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (isHexadecimalToken(token))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (decoded == false)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"for","name":"","isAbstract":false,"isInherited":false,"header":"for (index = 0;  index < length;  index++)","isStatic":false},{"isProperty":false,"parameters":["string atoken"],"datatype":"string","name":"unsaltToken","isAbstract":false,"isInherited":false,"header":"string unsaltToken(string atoken)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (isHexadecimalToken(token))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (decoded == false || decoded.length != TOKEN_WITH_CHECKSUM_LENGTH * 2)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"for","name":"","isAbstract":false,"isInherited":false,"header":"for (index = 0;  index < TOKEN_WITH_CHECKSUM_LENGTH;  index++)","isStatic":false},{"isProperty":false,"parameters":["string csrfToken"],"datatype":"protected","name":"bool _verifyToken","isAbstract":false,"isInherited":false,"header":"protected bool _verifyToken(string csrfToken)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (!decoded || decoded.length <= TOKEN_VALUE_LENGTH)","isStatic":false},{"isProperty":false,"parameters":["IServerRequest serverRequest"],"datatype":"protected","name":"void _validateToken","isAbstract":false,"isInherited":false,"header":"protected void _validateToken(IServerRequest serverRequest)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (!cookie || !isString(cookie))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (!_verifyToken(cookie))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (parsedBody.isArray || cast(DArrayAccess)parsedBody)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (hash_equals(post, cookie))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (hash_equals(aHeader, cookie))","isStatic":false},{"isProperty":false,"parameters":["string cookieValue","IServerRequest serverRequest"],"datatype":"protected","name":"ICookie _createCookie","isAbstract":false,"isInherited":false,"header":"protected ICookie _createCookie(string cookieValue, IServerRequest serverRequest)","isStatic":false}]</td></tr><tr><td>type:class</td></tr></table>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <!-- About section one-->
            <section class="py-5 bg-light" id="scroll-target">
                <div class="container px-5 my-5">
                </div>
            </section>
        </main>
        <!-- Footer-->
        <footer class="bg-dark py-4 mt-auto">
    <div class="container px-5">
        <div class="row align-items-center justify-content-between flex-column flex-sm-row">
            <div class="col-auto"><div class="small m-0 text-white">Copyright &copy; 2015 - 2024 Ozan Nurettin Süel</div></div>
            <div class="col-auto">
                <a class="link-light small" href="#!">Privacy</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="#!">Terms</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="#!">Contact</a>
            </div>
        </div>
    </div>
</footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
