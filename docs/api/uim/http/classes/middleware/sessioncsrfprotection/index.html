<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />
        <title>Modern Business - uim Framework</title>
        <!-- Favicon-->
        <link rel="icon" type="image/x-icon" href="https://uimsolutions.github.io/uim/assets/favicon.ico" />
        <!-- Bootstrap icons-->
        <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css" rel="stylesheet" />
        <!-- Core theme CSS (includes Bootstrap)-->
        <link href="https://uimsolutions.github.io/uim/css/styles.css" rel="stylesheet" />
    </head>
    <body class="d-flex flex-column">
        <main class="flex-shrink-0">
            <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container px-5">
        <a class="navbar-brand" href="index.html">uim</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"><span class="navbar-toggler-icon"></span></button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
                <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
                <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
                <li class="nav-item"><a class="nav-link" href="contact.html">Contact</a></li>
                <li class="nav-item"><a class="nav-link" href="faq.html">FAQ</a></li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdownBlog" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Packages</a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownBlog">
                        <li><a class="dropdown-item" href="blog-home.html">Blog Home</a></li>
                        <li><a class="dropdown-item" href="blog-post.html">Blog Post</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdownBlog" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Blog</a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownBlog">
                        <li><a class="dropdown-item" href="blog-home.html">Blog Home</a></li>
                        <li><a class="dropdown-item" href="blog-post.html">Blog Post</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="navbarDropdownPortfolio" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Portfolio</a>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownPortfolio">
                        <li><a class="dropdown-item" href="portfolio-overview.html">Portfolio Overview</a></li>
                        <li><a class="dropdown-item" href="portfolio-item.html">Portfolio Item</a></li>
                    </ul>
                </li>
            </ul>
        </div>
    </div>
</nav>	

            <!-- Header-->
            <header class="py-5">
                <div class="container px-5">
                    <div class="row justify-content-center">
                        <div class="col-lg-8 col-xxl-6">
                            <div class="text-left my-5">
                                <nav aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/index.html">API</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/index.html">uim</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/http/index.html">http</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/http/classes/index.html">classes</a></li><li class="breadcrumb-item"><a href="https://uimsolutions.github.io/uim/api/uim/http/classes/middleware/index.html">middleware</a></li><li class="breadcrumb-item active" aria-current="page">sessioncsrfprotection</li></ol></nav>
                                <h1 class="fw-bolder mb-3">Class DSessionCsrfProtectionMiddleware</h1>
                                <table><tr><td>filepath:C:\Users\ONS\PROJECTS2023\uim\http\uim\http\classes\middleware\sessioncsrfprotection.d</td></tr><tr><td>parents:[]</td></tr><tr><td>namespace:uim.http.classes.middleware.sessioncsrfprotection</td></tr><tr><td>name:DSessionCsrfProtectionMiddleware</td></tr><tr><td>content:["    mixin(MiddlewareThis!(\"SessionCsrfProtection\"));","    /**","     * Config for the CSRF handling.","     *","     * - `key` The session key to use. Defaults to `csrfToken`","     * - `field` The form field to check. Changing this will also require configuring","     *  FormHelper.","     */","    protected Json _config = [","        \"key\": Json(\"csrfToken\"),","        \"field\": Json(\"_csrfToken\"),","    ];","    /**","     * Callback for deciding whether to skip the token check for particular request.","     *","     * CSRF protection token check will be skipped if the callback returns `true`.","     *","     * @var callable|null","     */","    protected skipCheckCallback;","    const int TOKEN_VALUE_LENGTH = 32;","    this(Json[string] configData = null) {","       _config = configData + _config;","    }","    /**","     * Checks and sets the CSRF token depending on the HTTP verb.","     * Params:","     * \\Psr\\Http\\Message\\IServerRequest serverRequest The request.","     */","    IResponse process(IServerRequest serverRequest, IRequestHandler requestHandler) {","        auto method = serverRequest.getMethod();","        auto hasData = isIn(method, [\"PUT\", \"POST\", \"DELETE\", \"PATCH\"], true)","            || request.getParsedBody();","        if (","            hasData","            && this.skipCheckCallback !is null","            && call_user_func(this.skipCheckCallback, serverRequest) == true","       ) {","            return requestHandler.handle(this.unsetTokenField(serverRequest));","        }","        session = request.getAttribute(\"session\");","        if (!session || !(cast(DSession)session)) {","            throw new DException(\"You must have a `session` attribute to use session based CSRF tokens\");","        }","        token = session.read(configuration.getString(\"key\"));","        if (token.isNull) {","            token = this.createToken();","            session.write(configuration.getString(\"key\"), token);","        }","        request = request.withAttribute(\"csrfToken\", this.saltToken(token));","        if (method == \"GET\") {","            return handler.handle(request);","        }","        if (hasData) {","            this.validateToken(request, session);","            request = this.unsetTokenField(request);","        }","        return handler.handle(request);","    }","    /**","     * Set callback for allowing to skip token check for particular request.","     *","     * The callback will receive request instance as argument and must return","     * `true` if you want to skip token check for the current request.","     * Params:","     * callable aCallback A callable.","     */","    void skipCheckCallback(callable aCallback) {","        this.skipCheckCallback = aCallback;","    }","    /**","     * Apply entropy to a CSRF token","     *","     * To avoid BREACH apply a random salt value to a token","     * When the token is compared to the session the token needs","     * to be unsalted.","     *","     * tokenToSalt - The token to salt.","     */","    string saltToken(string tokenToSalt) {","        string decodedToken = base64_decode(tokenToSalt);","        auto tokenLength = decodedToken.length;","        string salt = Security.randomBytes(length);","        string salted;","        for (index = 0;  index < length;  index++) {","            // XOR the token and salt together so that we can reverse it later.","            salted ~= chr(ord(decodedToken[index]) ^ ord(salt[index]));","        }","        return base64_encode(salted ~ salt);","    }","    /**","     * Remove the salt from a CSRF token.","     *","     * If the token is not TOKEN_VALUE_LENGTH * 2 it is an old","     * unsalted value that is supported for backwards compatibility.","     * Params:","     * string atoken The token that could be salty.","     */","    protected string unsaltToken(string atoken) {","        string decodedToken = base64_decode(token, true);","        if (decodedToken == false || decodedToken.length != TOKEN_VALUE_LENGTH * 2) {","            return token;","        }","        string salted = subString(decodedToken, 0, TOKEN_VALUE_LENGTH);","        string salt = subString(decodedToken, TOKEN_VALUE_LENGTH);","        string unsalted = \"\";","        for (index = 0;  index < TOKEN_VALUE_LENGTH;  index++) {","            // Reverse the XOR to desalt.","            unsalted ~= chr(ord(salted[index]) ^ ord(salt[index]));","        }","        return base64_encode(unsalted);","    }","    /**","     * Remove CSRF protection token from request data.","     *","     * This ensures that the token does not cause failures during form tampering protection.","     */","    protected IServerRequest unsetTokenField(IServerRequest serverRequest) {","        auto parsedBody = request.getParsedBody();","        IServerRequest request = serverRequest;","        if (parsedBody.isArray) {","            parsedBody.removeKey(configuration.getString(\"field\"));","            request = request.withParsedBody(parsedBody);","        }","        return request;","    }","    /**","     * Create a new token to be used for CSRF protection","     *","     * This token is a simple unique random value as the compare","     * value is stored in the session where it cannot be tampered with.","     */","    string createToken() {","        return base64_encode(Security.randomBytes(TOKEN_VALUE_LENGTH));","    }","    // Validate the request data against the cookie token.","    protected void validateToken(IServerRequest serverRequest, DSession session) {","        auto token = session.read(configuration.getString(\"key\"));","        if (!token || !isString(token)) {","            throw new DInvalidCsrfTokenException(__d(\"uim\", \"Missing or incorrect CSRF session key\"));","        }","        auto parsedBody = request.getParsedBody();","        if (parsedBody.isArray || cast(DArrayAccess)parsedBody) {","            auto post = to!string(Hash.get(body, configuration.get(\"field\")));","            post = this.unsaltToken(post);","            if (hash_equals(post, token)) {","                return;","            }","        }","        auto aHeader = request.getHeaderLine(\"X-CSRF-Token\");","         aHeader = this.unsaltToken(aHeader);","        if (hash_equals(aHeader, token)) {","            return;","        }","        throw new DInvalidCsrfTokenException(__d(","            \"uim\",","            \"CSRF token from either the request body or request headers did not match or is missing.\"","       ));","    }","    /**","     * Replace the token in the provided request.","     *","     * Replace the token in the session and request attribute. Replacing","     * tokens is a good idea during privilege escalation or privilege reduction.","     */","    static DServerRequest replaceToken(ServerRequest serverRequest, string key = \"csrfToken\") {","        auto middleware = new DSessionCsrfProtectionMiddleware([\"key\": key]);","        auto createdToken = middleware.createToken();","        request.getSession().write(key, createdToken);","        return request.withAttribute(key, middleware.saltToken(createdToken));","    }"]</td></tr><tr><td>methods:[{"isProperty":false,"datatype":null,"name":"this","isAbstract":false,"isInherited":false,"header":"this(Json[string] configData = null)","isStatic":false},{"isProperty":false,"parameters":["IServerRequest serverRequest","IRequestHandler requestHandler"],"datatype":"IResponse","name":"process","isAbstract":false,"isInherited":false,"header":"IResponse process(IServerRequest serverRequest, IRequestHandler requestHandler)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (!session || !(cast(DSession)session))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (token.isNull)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (method == \"GET\")","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (hasData)","isStatic":false},{"isProperty":false,"parameters":["callable aCallback"],"datatype":"void","name":"skipCheckCallback","isAbstract":false,"isInherited":false,"header":"void skipCheckCallback(callable aCallback)","isStatic":false},{"isProperty":false,"parameters":["string tokenToSalt"],"datatype":"string","name":"saltToken","isAbstract":false,"isInherited":false,"header":"string saltToken(string tokenToSalt)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"for","name":"","isAbstract":false,"isInherited":false,"header":"for (index = 0;  index < length;  index++)","isStatic":false},{"isProperty":false,"parameters":["string atoken"],"datatype":"protected","name":"string unsaltToken","isAbstract":false,"isInherited":false,"header":"protected string unsaltToken(string atoken)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (decodedToken == false || decodedToken.length != TOKEN_VALUE_LENGTH * 2)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"for","name":"","isAbstract":false,"isInherited":false,"header":"for (index = 0;  index < TOKEN_VALUE_LENGTH;  index++)","isStatic":false},{"isProperty":false,"parameters":["IServerRequest serverRequest"],"datatype":"protected","name":"IServerRequest unsetTokenField","isAbstract":false,"isInherited":false,"header":"protected IServerRequest unsetTokenField(IServerRequest serverRequest)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (parsedBody.isArray)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"string","name":"createToken","isAbstract":false,"isInherited":false,"header":"string createToken()","isStatic":false},{"isProperty":false,"parameters":["IServerRequest serverRequest","DSession session"],"datatype":"protected","name":"void validateToken","isAbstract":false,"isInherited":false,"header":"protected void validateToken(IServerRequest serverRequest, DSession session)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (!token || !isString(token))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (parsedBody.isArray || cast(DArrayAccess)parsedBody)","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (hash_equals(post, token))","isStatic":false},{"isProperty":false,"parameters":[],"datatype":"if","name":"","isAbstract":false,"isInherited":false,"header":"if (hash_equals(aHeader, token))","isStatic":false},{"isProperty":false,"parameters":["ServerRequest serverRequest","string key = \"csrfToken\""],"datatype":"DServerRequest","name":"replaceToken","isAbstract":false,"isInherited":false,"header":"DServerRequest replaceToken(ServerRequest serverRequest, string key = \"csrfToken\")","isStatic":true}]</td></tr><tr><td>type:class</td></tr></table>
                            </div>
                        </div>
                    </div>
                </div>
            </header>
            <!-- About section one-->
            <section class="py-5 bg-light" id="scroll-target">
                <div class="container px-5 my-5">
                </div>
            </section>
        </main>
        <!-- Footer-->
        <footer class="bg-dark py-4 mt-auto">
    <div class="container px-5">
        <div class="row align-items-center justify-content-between flex-column flex-sm-row">
            <div class="col-auto"><div class="small m-0 text-white">Copyright &copy; 2015 - 2024 Ozan Nurettin Süel</div></div>
            <div class="col-auto">
                <a class="link-light small" href="#!">Privacy</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="#!">Terms</a>
                <span class="text-white mx-1">&middot;</span>
                <a class="link-light small" href="#!">Contact</a>
            </div>
        </div>
    </div>
</footer>
        <!-- Bootstrap core JS-->
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Core theme JS-->
        <script src="js/scripts.js"></script>
    </body>
</html>
