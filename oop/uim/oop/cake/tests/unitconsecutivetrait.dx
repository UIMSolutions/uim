module source.uim.oop.tests.unitconsecutivetrait;

import uim.oop;

@safe:

template PHPUnitConsecutiveTemplate {
    /**
     * @param array firstCallArguments The call arguments
     * @param array ...consecutiveCallsArguments Additional arguments
     */
    static iterable withConsecutive(array firstCallArguments, array ...consecutiveCallsArguments) {
        allConsecutiveCallsArguments = [firstCallArguments, ...consecutiveCallsArguments];

        numberOfArguments = count(firstCallArguments);
        argumentList = [];
        for (argumentPosition = 0; argumentPosition < numberOfArguments; argumentPosition++) {
            argumentList[argumentPosition] = array_column(allConsecutiveCallsArguments, argumentPosition);
        }
        mockedMethodCall = 0;
        aCallbackCall = 0;
        foreach (argumentList as  anIndex: argument) {
            yield new Callback(
                static auto (Json actualArgument) use (
                    argumentList,
                    &mockedMethodCall,
                    &aCallbackCall,
                     anIndex,
                    numberOfArguments
                ): bool {
                    expected = argumentList[anIndex][mockedMethodCall] ?? null;

                    aCallbackCall++;
                    mockedMethodCall = to!int((aCallbackCall / numberOfArguments));

                    if (cast(Constraint)expected) {
                        self.assertThat(actualArgument, expected);
                    } else {
                        self.assertEquals(expected, actualArgument);
                    }
                    return true;
                },
            );
        }
    }
}
