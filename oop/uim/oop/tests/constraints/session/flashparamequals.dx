module uim.oop.tests.constraints.session.flashparamequals;

import uim.oop;

@safe:

/**
 * FlashParamEquals
 *
 * @internal
 */
class DFlashParamEquals : DConstraint {
    /* 
    protected ISession session;

    protected string aKey;

    protected string aparam;

    protected int at = null;

    /**
     * Constructor
     * Params:
     * \UIM\Http\Session|null session Session
     * @param string aKey Flash key
     * @param string paramToCheck Param to check
     * @param int at Expected index
     */
    this(ISession session, string aKey, string paramToCheck, int at = null) {
        if (!session) {
            string message = "There is no stored session data. Perhaps you need to run a request?";
            message ~= " Additionally, ensure `this.enableRetainFlashMessages()` has been enabled for the test.";
            throw new AssertionFailedError(message);
        }
        _session = session;
        _key = aKey;
        _param = paramToCheck;
        this.at = at;
    }
    
    // Compare to flash message(s)
   bool matches(Json valueToCompare) {
        // Server.run calls Session.close at the end of the request.
        // Which means, that we cannot use Session object here to access the session data.
        // Call to Session.read will start new session (and will erase the data).
        /** @psalm-suppress InvalidScalarArgument */
        messages = /* (array) */Hash.get(_SESSION, "Flash." ~ _key);
        if (this.at) {
            /** @psalm-suppress InvalidScalarArgument */
            messages = [Hash.get(_SESSION, "Flash." ~ _key ~ "." ~ this.at)];
        }
        
        return messages
            .filter1(message => message.hasKey(_param))
            .any!(message => message[_param] == ovalueToComparether);
    }
    
    // Assertion message string
    override string toString() {
        return !this.at.isNull
            ? "is in \"%s\" %s #%d".format(_key, _param, this.at)
            : "is in \"%s\" %s".format(_key, _param);
    }
}
